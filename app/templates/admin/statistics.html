{% extends "base.html" %}

{% block title %}Статистика - Админ панель{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mt-4">Детальная статистика</h1>

    <!-- Фильтры -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Фильтры</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <label>Дата с:</label>
                    <input type="date" id="dateFrom" class="form-control">
                </div>
                <div class="col-md-3">
                    <label>Дата по:</label>
                    <input type="date" id="dateTo" class="form-control">
                </div>
                <div class="col-md-3">
                    <label>Категория:</label>
                    <select id="categoryFilter" class="form-select">
                        <option value="">Все категории</option>
                        <option value="спорт">Спорт</option>
                        <option value="культура">Культура</option>
                        <option value="детский досуг">Детский досуг</option>
                        <option value="экология">Экология</option>
                        <option value="транспорт">Транспорт</option>
                        <option value="озеленение">Озеленение</option>
                        <option value="освещение">Освещение</option>
                        <option value="безопасность">Безопасность</option>
                        <option value="другое">Другое</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label>&nbsp;</label>
                    <button class="btn btn-primary w-100" onclick="loadStatistics()">
                        <i class="bi bi-filter"></i> Применить
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Активность по дням -->
        <div class="col-xl-12 col-lg-12 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Активность пользователей</h6>
                </div>
                <div class="card-body">
                    <div class="chart-area">
                        <canvas id="activityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Топ идей -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Топ 10 идей по голосам</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Название</th>
                                    <th>Автор</th>
                                    <th>Голосов</th>
                                    <th>Категория</th>
                                </tr>
                            </thead>
                            <tbody id="topIdeasBody">
                                <!-- Заполнится через JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Топ пользователей -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Активные пользователи</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Пользователь</th>
                                    <th>Идеи</th>
                                    <th>Голосов</th>
                                    <th>Комментарии</th>
                                </tr>
                            </thead>
                            <tbody id="topUsersBody">
                                <!-- Заполнится через JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Экспорт данных -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Экспорт данных</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <button class="btn btn-success w-100 mb-2" onclick="exportData('ideas')">
                        <i class="bi bi-download"></i> Экспорт идей (CSV)
                    </button>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-success w-100 mb-2" onclick="exportData('users')">
                        <i class="bi bi-download"></i> Экспорт пользователей (CSV)
                    </button>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-success w-100 mb-2" onclick="exportData('votes')">
                        <i class="bi bi-download"></i> Экспорт голосов (CSV)
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let activityChart;

document.addEventListener('DOMContentLoaded', function() {
    // Установка дат по умолчанию (последние 30 дней)
    const today = new Date();
    const monthAgo = new Date();
    monthAgo.setDate(today.getDate() - 30);

    document.getElementById('dateFrom').valueAsDate = monthAgo;
    document.getElementById('dateTo').valueAsDate = today;

    loadStatistics();
});

function loadStatistics() {
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    const category = document.getElementById('categoryFilter').value;

    // Загрузка данных активности
    fetch(`/api/admin/detailed-stats?date_from=${dateFrom}&date_to=${dateTo}&category=${category}`)
        .then(response => response.json())
        .then(data => {
            // Обновление графика активности
            updateActivityChart(data.daily_activity);

            // Обновление таблицы топ идей
            updateTopIdeas(data.top_ideas);

            // Обновление таблицы топ пользователей
            updateTopUsers(data.top_users);
        });
}

function updateActivityChart(activityData) {
    const ctx = document.getElementById('activityChart').getContext('2d');

    if (activityChart) {
        activityChart.destroy();
    }

    const labels = activityData.map(item => item.date);
    const data = activityData.map(item => item.count);

    activityChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Количество идей',
                data: data,
                borderColor: '#4e73df',
                backgroundColor: 'rgba(78, 115, 223, 0.05)',
                pointBackgroundColor: '#4e73df',
                pointBorderColor: '#4e73df',
                pointRadius: 3,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            scales: {
                x: {
                    grid: {
                        display: false
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

function updateTopIdeas(ideas) {
    const tbody = document.getElementById('topIdeasBody');
    tbody.innerHTML = '';

    ideas.forEach((idea, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${index + 1}</td>
            <td><a href="/admin/ideas/${idea.id}">${idea.title}</a></td>
            <td>${idea.author}</td>
            <td><span class="badge bg-primary">${idea.votes_count}</span></td>
            <td><span class="badge bg-secondary">${idea.category}</span></td>
        `;
        tbody.appendChild(row);
    });
}

function updateTopUsers(users) {
    const tbody = document.getElementById('topUsersBody');
    tbody.innerHTML = '';

    users.forEach((user, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${index + 1}</td>
            <td>${user.username}</td>
            <td><span class="badge bg-info">${user.ideas_count}</span></td>
            <td><span class="badge bg-success">${user.votes_given}</span></td>
            <td><span class="badge bg-warning">${user.comments_count}</span></td>
        `;
        tbody.appendChild(row);
    });
}

function exportData(type) {
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    const category = document.getElementById('categoryFilter').value;

    window.open(`/api/admin/export/${type}?date_from=${dateFrom}&date_to=${dateTo}&category=${category}`, '_blank');
}

// Автоматическое обновление каждые 5 минут
setInterval(loadStatistics, 5 * 60 * 1000);
</script>
{% endblock %}
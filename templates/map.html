{% extends "base.html" %}

{% block title %}Карта общественных инициатив г. Рубцовск{{ super() }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    #map {
        height: 600px;
        border-radius: 8px;
        border: 1px solid #ddd;
    }
    .legend {
        padding: 10px;
        background: white;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin-right: 8px;
        opacity: 0.7;
    }
    .legend-item {
        margin-bottom: 5px;
    }
    .idea-card {
        transition: all 0.3s ease;
        cursor: pointer;
    }
    .idea-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .filter-section {
        margin-bottom: 15px;
    }
    /* Дополнительный стиль для кнопки */
    .btn-add-idea {
        font-size: 1.2rem;
        padding: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-3">
        <!-- Карточка фильтров -->
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">Фильтры</h5>
            </div>
            <div class="card-body">
                <div class="filter-section">
                    <label class="form-label fw-bold">Категория:</label>
                    <select id="categoryFilter" class="form-select">
                        <option value="">Все категории</option>
                        {% for category in categories %}
                            <option value="{{ category }}">{{ category|capitalize }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-section">
                    <label class="form-label fw-bold">Статус:</label>
                    <select id="statusFilter" class="form-select">
                        <option value="">Все статусы</option>
                        <option value="pending">На рассмотрении</option>
                        <option value="approved">Одобрено</option>
                        <option value="rejected">Отклонено</option>
                        <option value="implemented">Реализовано</option>
                    </select>
                </div>
                <div class="d-grid gap-2 mt-3">
                    <button class="btn btn-success" onclick="loadIdeas()">
                        <i class="bi bi-funnel"></i> Применить фильтры
                    </button>
                    <button class="btn btn-outline-secondary" onclick="resetFilters()">
                        <i class="bi bi-x-circle"></i> Сбросить фильтры
                    </button>
                </div>
            </div>
        </div>

        <!-- Новая крупная кнопка "Добавить идею" (только для авторизованных) -->
        {% if current_user.is_authenticated %}
        <div class="card mt-3">
            <div class="card-body">
                <button class="btn btn-success btn-lg w-100 btn-add-idea" data-bs-toggle="modal" data-bs-target="#addIdeaModal">
                    <i class="bi bi-plus-circle"></i> Добавить идею
                </button>
            </div>
        </div>
        {% endif %}

        <!-- Легенда карты -->
        <div class="card mt-3">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">Легенда карты</h5>
            </div>
            <div class="card-body">
                <div class="legend">
                    <div class="legend-item">
                        <i style="background: #28a745; border-radius: 50%;"></i>
                        <span>Реализовано</span>
                    </div>
                    <div class="legend-item">
                        <i style="background: #007bff; border-radius: 50%;"></i>
                        <span>Одобрено</span>
                    </div>
                    <div class="legend-item">
                        <i style="background: #ffc107; border-radius: 50%;"></i>
                        <span>На рассмотрении</span>
                    </div>
                    <div class="legend-item">
                        <i style="background: #dc3545; border-radius: 50%;"></i>
                        <span>Отклонено</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Статистика -->
        <div class="card mt-3">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">Статистика</h5>
            </div>
            <div class="card-body text-center">
                <div class="row">
                    <div class="col-6">
                        <h4 id="ideasCount">0</h4>
                        <small class="text-muted">Идей</small>
                    </div>
                    <div class="col-6">
                        <h4 id="filteredCount">0</h4>
                        <small class="text-muted">Показано</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-9">
        <!-- Карта -->
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-map"></i> Карта общественных инициатив г. Рубцовск
                </h5>
            </div>
            <div class="card-body">
                <div id="map"></div>
                <div class="mt-2 text-muted small">
                    <i class="bi bi-info-circle"></i> Нажмите на маркер на карте или карточку в списке для подробной информации
                </div>
            </div>
        </div>

        <!-- Список идей -->
        <div class="card mt-3">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-list-ul"></i> Список идей
                    <span id="listCount" class="badge bg-light text-dark ms-2">0</span>
                </h5>
            </div>
            <div class="card-body">
                <div id="ideasList" class="text-center">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <p class="mt-2">Загрузка идей...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Idea Details Modal -->
<div class="modal fade" id="ideaModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="ideaTitle"></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="ideaContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let map;
    let markers = {};
    let currentIdeas = [];

    function initMap() {
        // Инициализируем карту с центром в Рубцовске
        map = L.map('map').setView({{ map_center }}, {{ map_zoom }});

        // Добавляем слой OpenStreetMap
        L.tileLayer('{{ config.MAP_TILES }}', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Добавляем маркер центра города
        L.marker({{ map_center }})
            .addTo(map)
            .bindPopup('<b>Центр Рубцовска</b>')
            .openPopup();

        // Загружаем идеи
        loadIdeas();
    }

    function getStatusColor(status) {
        const colors = {
            'implemented': '#28a745',
            'approved': '#007bff',
            'pending': '#ffc107',
            'rejected': '#dc3545'
        };
        return colors[status] || '#6c757d';
    }

    function getStatusText(status) {
        const texts = {
            'implemented': 'Реализовано',
            'approved': 'Одобрено',
            'pending': 'На рассмотрении',
            'rejected': 'Отклонено'
        };
        return texts[status] || status;
    }

    function getCategoryIcon(category) {
        const icons = {
            'спорт': 'bi-trophy',
            'культура': 'bi-music-note-beamed',
            'детский досуг': 'bi-emoji-smile',
            'экология': 'bi-tree',
            'транспорт': 'bi-bus-front',
            'озеленение': 'bi-flower1',
            'освещение': 'bi-lightbulb',
            'безопасность': 'bi-shield-check'
        };
        return icons[category] || 'bi-geo-alt';
    }

    function resetFilters() {
        document.getElementById('categoryFilter').value = '';
        document.getElementById('statusFilter').value = '';
        loadIdeas();
    }

    async function loadIdeas() {
        const category = document.getElementById('categoryFilter').value;
        const status = document.getElementById('statusFilter').value;

        // Показываем индикатор загрузки
        document.getElementById('ideasList').innerHTML = `
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Загрузка...</span>
            </div>
            <p class="mt-2">Загрузка идей...</p>
        `;

        try {
            // Очищаем существующие маркеры
            Object.values(markers).forEach(marker => marker.remove());
            markers = {};

            // Загружаем идеи из API
            const response = await fetch(`/api/ideas?category=${category}&status=${status}`);
            currentIdeas = await response.json();

            let ideasHtml = '';
            let hasIdeas = false;

            currentIdeas.forEach(idea => {
                hasIdeas = true;
                // Добавляем маркер на карту
                const marker = L.circleMarker([idea.latitude, idea.longitude], {
                    radius: 10,
                    fillColor: getStatusColor(idea.status),
                    color: '#ffffff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);

                marker.bindPopup(`
                    <div style="min-width: 250px;">
                        <h6><strong>${idea.title}</strong></h6>
                        <p><small>${idea.description.substring(0, 100)}...</small></p>
                        <p><strong>Категория:</strong> ${idea.category}</p>
                        <p><strong>Статус:</strong> <span class="badge" style="background: ${getStatusColor(idea.status)}">${getStatusText(idea.status)}</span></p>
                        <div class="text-center mt-2">
                            <button class="btn btn-sm btn-success" onclick="showIdeaDetails(${idea.id})">
                                <i class="bi bi-info-circle"></i> Подробнее
                            </button>
                        </div>
                    </div>
                `);

                markers[idea.id] = marker;

                // Добавляем в список
                ideasHtml += `
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 idea-card" onclick="showIdeaDetails(${idea.id})">
                            <div class="card-body">
                                <h6 class="card-title text-truncate">${idea.title}</h6>
                                <p class="card-text small text-muted">${idea.description.substring(0, 120)}...</p>
                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    <span class="badge bg-secondary">
                                        <i class="bi ${getCategoryIcon(idea.category)}"></i> ${idea.category}
                                    </span>
                                    <span class="badge" style="background: ${getStatusColor(idea.status)}">
                                        ${getStatusText(idea.status)}
                                    </span>
                                </div>
                                <div class="mt-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted">
                                            <i class="bi bi-calendar"></i> ${new Date(idea.created_at).toLocaleDateString('ru-RU')}
                                        </small>
                                        <div>
                                            <button class="btn btn-sm btn-outline-success" onclick="event.stopPropagation(); voteIdea(${idea.id}, 'up')">
                                                <i class="bi bi-hand-thumbs-up"></i> ${idea.votes_count}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            if (!hasIdeas) {
                ideasHtml = `
                    <div class="col-12">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> По выбранным фильтрам идей не найдено. Попробуйте изменить фильтры или <a href="#" data-bs-toggle="modal" data-bs-target="#addIdeaModal">добавить свою идею</a>!
                        </div>
                    </div>
                `;
            }

            document.getElementById('ideasList').innerHTML = `
                <div class="row">
                    ${ideasHtml}
                </div>
            `;

            // Обновляем статистику
            document.getElementById('ideasCount').textContent = currentIdeas.length;
            document.getElementById('filteredCount').textContent = currentIdeas.length;
            document.getElementById('listCount').textContent = currentIdeas.length;

            // Подгоняем карту ко всем маркерам
            if (currentIdeas.length > 0) {
                const markerBounds = L.latLngBounds(
                    currentIdeas.map(idea => [idea.latitude, idea.longitude])
                );
                map.fitBounds(markerBounds.pad(0.1));
            }

        } catch (error) {
            console.error('Ошибка загрузки идей:', error);
            document.getElementById('ideasList').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i> Ошибка загрузки идей. Пожалуйста, попробуйте позже.
                </div>
            `;
        }
    }

    async function showIdeaDetails(ideaId) {
        try {
            const response = await fetch(`/api/ideas/${ideaId}`);
            const idea = await response.json();

            document.getElementById('ideaTitle').textContent = idea.title;
            document.getElementById('ideaContent').innerHTML = `
                <div class="row">
                    <div class="col-md-8">
                        <p><strong>Описание:</strong></p>
                        <p class="mb-4">${idea.description}</p>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <p><strong>Категория:</strong><br>
                                <span class="badge bg-secondary">${idea.category}</span></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Статус:</strong><br>
                                <span class="badge" style="background: ${getStatusColor(idea.status)}">
                                    ${getStatusText(idea.status)}
                                </span></p>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <p><strong>Автор:</strong><br>${idea.author}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Дата добавления:</strong><br>
                                ${new Date(idea.created_at).toLocaleDateString('ru-RU', { 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric' 
                                })}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">Статистика</h6>
                                <div class="text-center">
                                    <h1 class="display-4 text-success">${idea.votes_count}</h1>
                                    <p class="text-muted">голосов поддержки</p>
                                </div>
                                <div class="d-grid">
                                    <button class="btn btn-success" onclick="voteIdea(${idea.id}, 'up')">
                                        <i class="bi bi-hand-thumbs-up"></i> Поддержать идею
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <p><strong>Местоположение на карте:</strong></p>
                    <div id="detailMap" style="height: 200px; border-radius: 8px;"></div>
                </div>
            `;

            // Инициализируем мини-карту для детального просмотра
            const detailMap = L.map('detailMap').setView([idea.latitude, idea.longitude], 15);
            L.tileLayer('{{ config.MAP_TILES }}', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(detailMap);
            
            L.marker([idea.latitude, idea.longitude])
                .addTo(detailMap)
                .bindPopup(`<strong>${idea.title}</strong>`)
                .openPopup();

            // Показываем модальное окно
            const modal = new bootstrap.Modal(document.getElementById('ideaModal'));
            modal.show();

        } catch (error) {
            console.error('Ошибка загрузки деталей идеи:', error);
            alert('Не удалось загрузить информацию об идее');
        }
    }

    async function voteIdea(ideaId, voteType) {
        if (!{{ 'true' if current_user.is_authenticated else 'false' }}) {
            alert('Пожалуйста, войдите в систему, чтобы голосовать за идеи');
            return;
        }

        try {
            const response = await fetch(`/api/ideas/${ideaId}/vote`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({vote_type: voteType})
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Показываем уведомление
                const toast = document.createElement('div');
                toast.className = 'toast align-items-center text-white bg-success border-0 position-fixed bottom-0 end-0 m-3';
                toast.innerHTML = `
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="bi bi-check-circle"></i> Ваш голос учтен!
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                `;
                document.body.appendChild(toast);
                bootstrap.Toast.getOrCreateInstance(toast).show();
                
                // Удаляем уведомление через 3 секунды
                setTimeout(() => toast.remove(), 3000);
                
                // Обновляем данные
                loadIdeas();
            } else {
                alert('Ошибка при голосовании: ' + data.error);
            }
        } catch (error) {
            console.error('Ошибка голосования:', error);
            alert('Произошла ошибка при голосовании');
        }
    }

    // Инициализируем карту после загрузки DOM
    document.addEventListener('DOMContentLoaded', initMap);
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Карта общественных инициатив г. Рубцовск{{ super() }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    #map {
        height: 600px;
        border-radius: 8px;
        border: 1px solid #ddd;
    }
    .legend {
        padding: 10px;
        background: white;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin-right: 8px;
        opacity: 0.7;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Фильтры</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Категория:</label>
                    <select id="categoryFilter" class="form-select">
                        <option value="">Все категории</option>
                        {% for category in categories %}
                            <option value="{{ category }}">{{ category|capitalize }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Статус:</label>
                    <select id="statusFilter" class="form-select">
                        <option value="">Все статусы</option>
                        <option value="pending">На рассмотрении</option>
                        <option value="approved">Одобрено</option>
                        <option value="rejected">Отклонено</option>
                        <option value="implemented">Реализовано</option>
                    </select>
                </div>
                <button class="btn btn-primary w-100" onclick="loadIdeas()">Применить фильтры</button>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">Легенда</h5>
            </div>
            <div class="card-body">
                <div class="legend">
                    <div><i style="background: #28a745;"></i> Реализовано</div>
                    <div><i style="background: #007bff;"></i> Одобрено</div>
                    <div><i style="background: #ffc107;"></i> На рассмотрении</div>
                    <div><i style="background: #dc3545;"></i> Отклонено</div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-9">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Карта общественных инициатив г. Кисилевск</h5>
            </div>
            <div class="card-body">
                <div id="map"></div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">Список идей</h5>
            </div>
            <div class="card-body">
                <div id="ideasList"></div>
            </div>
        </div>
    </div>
</div>

<!-- Idea Details Modal -->
<div class="modal fade" id="ideaModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ideaTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="ideaContent"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let map;
    let markers = {};

    function initMap() {
        map = L.map('map').setView({{ map_center }}, {{ map_zoom }});

        L.tileLayer('{{ config.MAP_TILES }}', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        loadIdeas();
    }

    function getStatusColor(status) {
        const colors = {
            'implemented': '#28a745',
            'approved': '#007bff',
            'pending': '#ffc107',
            'rejected': '#dc3545'
        };
        return colors[status] || '#6c757d';
    }

    function getCategoryIcon(category) {
        const icons = {
            'спорт': 'bi-trophy',
            'культура': 'bi-music-note-beamed',
            'детский досуг': 'bi-emoji-smile',
            'экология': 'bi-tree',
            'транспорт': 'bi-bus-front',
            'озеленение': 'bi-flower1',
            'освещение': 'bi-lightbulb',
            'безопасность': 'bi-shield-check'
        };
        return icons[category] || 'bi-geo-alt';
    }

    function loadIdeas() {
        const category = document.getElementById('categoryFilter').value;
        const status = document.getElementById('statusFilter').value;

        // Clear existing markers
        Object.values(markers).forEach(marker => marker.remove());
        markers = {};

        // Load ideas from API
        fetch(`/api/ideas?category=${category}&status=${status}`)
            .then(response => response.json())
            .then(ideas => {
                let ideasHtml = '<div class="row">';

                ideas.forEach(idea => {
                    // Add marker to map
                    const marker = L.circleMarker([idea.latitude, idea.longitude], {
                        radius: 8,
                        fillColor: getStatusColor(idea.status),
                        color: '#000',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);

                    marker.bindPopup(`
                        <h6>${idea.title}</h6>
                        <p>${idea.description.substring(0, 100)}...</p>
                        <p><strong>Категория:</strong> ${idea.category}</p>
                        <p><strong>Статус:</strong> ${idea.status}</p>
                        <button class="btn btn-sm btn-primary" onclick="showIdeaDetails(${idea.id})">
                            Подробнее
                        </button>
                    `);

                    markers[idea.id] = marker;

                    // Add to list
                    ideasHtml += `
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title">${idea.title}</h6>
                                    <p class="card-text small">${idea.description.substring(0, 150)}...</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge bg-secondary">${idea.category}</span>
                                        <span class="badge" style="background: ${getStatusColor(idea.status)}">
                                            ${idea.status}
                                        </span>
                                    </div>
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-outline-primary" onclick="showIdeaDetails(${idea.id})">
                                            <i class="bi bi-info-circle"></i> Подробнее
                                        </button>
                                        <button class="btn btn-sm btn-outline-success" onclick="voteIdea(${idea.id}, 'up')">
                                            <i class="bi bi-hand-thumbs-up"></i> ${idea.votes_count}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                ideasHtml += '</div>';
                document.getElementById('ideasList').innerHTML = ideasHtml;

                // Fit bounds to show all markers
                if (ideas.length > 0) {
                    const group = new L.featureGroup(Object.values(markers));
                    map.fitBounds(group.getBounds().pad(0.1));
                }
            });
    }

    function showIdeaDetails(ideaId) {
        fetch(`/api/ideas/${ideaId}`)
            .then(response => response.json())
            .then(idea => {
                document.getElementById('ideaTitle').textContent = idea.title;
                document.getElementById('ideaContent').innerHTML = `
                    <p>${idea.description}</p>
                    <p><strong>Категория:</strong> ${idea.category}</p>
                    <p><strong>Статус:</strong> ${idea.status}</p>
                    <p><strong>Автор:</strong> ${idea.author}</p>
                    <p><strong>Дата:</strong> ${new Date(idea.created_at).toLocaleDateString('ru-RU')}</p>
                    <p><strong>Голосов:</strong> ${idea.votes_count}</p>

                    <div class="mt-3">
                        <h6>Вложения:</h6>
                        <div id="attachments"></div>
                    </div>

                    <div class="mt-3">
                        <button class="btn btn-primary" onclick="voteIdea(${idea.id}, 'up')">
                            <i class="bi bi-hand-thumbs-up"></i> Поддерживаю
                        </button>
                    </div>
                `;

                // Load attachments
                fetch(`/api/ideas/${ideaId}/attachments`)
                    .then(response => response.json())
                    .then(attachments => {
                        const attachmentsDiv = document.getElementById('attachments');
                        attachments.forEach(attachment => {
                            if (attachment.file_type === 'image') {
                                attachmentsDiv.innerHTML += `
                                    <img src="/static/uploads/${attachment.filename}"
                                         class="img-thumbnail m-1"
                                         style="max-height: 150px;">
                                `;
                            }
                        });
                    });

                const modal = new bootstrap.Modal(document.getElementById('ideaModal'));
                modal.show();
            });
    }

    function voteIdea(ideaId, voteType) {
        if (!{{ 'true' if current_user.is_authenticated else 'false' }}) {
            alert('Пожалуйста, войдите в систему, чтобы голосовать');
            return;
        }

        fetch(`/api/ideas/${ideaId}/vote`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({vote_type: voteType})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadIdeas(); // Reload to update counts
            }
        });
    }

    document.addEventListener('DOMContentLoaded', initMap);
</script>
{% endblock %}